{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://archon72.local/schemas/contracts/task_state.schema.json",
  "title": "TaskState",
  "description": "State ledger per task, updated on TRA ingestion and reroute.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "task_id",
    "program_id",
    "tar_id",
    "tra_id",
    "last_updated_at",
    "state",
    "last_outcome_status",
    "blockers",
    "deliverables",
    "escalations"
  ],
  "properties": {
    "schema_version": { "type": "string", "const": "1.0" },
    "task_id": { "type": "string", "pattern": "^task-[a-zA-Z0-9\\-]+$" },
    "program_id": { "type": "string", "pattern": "^program-[a-zA-Z0-9\\-]+$" },
    "tar_id": { "type": "string", "pattern": "^tar-[a-zA-Z0-9\\-]+$" },
    "tra_id": { "type": "string", "pattern": "^tra-[a-zA-Z0-9\\-]+$" },
    "last_updated_at": { "type": "string", "minLength": 1 },
    "state": {
      "type": "string",
      "enum": ["ACTIVATION_SENT", "CLOSED", "CLOSED_PARTIAL", "NEEDS_REROUTE", "BLOCKED", "FAILED"]
    },
    "last_outcome_status": {
      "type": "string",
      "enum": ["COMPLETED", "PARTIAL", "BLOCKED", "FAILED", "DECLINED", "WITHDRAWN"]
    },
    "blockers": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["severity", "description", "needs_upstream_decision"],
        "properties": {
          "severity": { "type": "string", "enum": ["MINOR", "MAJOR", "SEVERE"] },
          "description": { "type": "string", "minLength": 1 },
          "needs_upstream_decision": { "type": "boolean" }
        }
      }
    },
    "deliverables": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "artifact_ref"],
        "properties": {
          "id": { "type": "string", "minLength": 1 },
          "artifact_ref": { "type": "string", "minLength": 1 }
        }
      }
    },
    "escalations": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["to", "reason", "ts"],
        "properties": {
          "to": { "type": "string", "enum": ["EARL", "DUKE", "PRESIDENT"] },
          "reason": { "type": "string", "minLength": 1 },
          "ts": { "type": "string", "minLength": 1 }
        }
      }
    },
    "attempt_count": {
      "type": "integer",
      "minimum": 0,
      "default": 0
    },
    "attempt_history": {
      "type": "array",
      "default": [],
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["tar_id", "tool_id", "created_at"],
        "properties": {
          "tar_id": { "type": "string", "pattern": "^tar-[a-zA-Z0-9\\-]+$" },
          "tool_id": { "type": "string", "minLength": 1 },
          "created_at": { "type": "string", "minLength": 1 }
        }
      }
    },
    "excluded_tools": {
      "type": "array",
      "default": [],
      "items": { "type": "string", "minLength": 1 }
    },
    "reroute_policy": {
      "type": "object",
      "additionalProperties": false,
      "default": { "max_attempts": 3, "escalate_on_exhaustion": true },
      "required": ["max_attempts", "escalate_on_exhaustion"],
      "properties": {
        "max_attempts": { "type": "integer", "minimum": 1, "maximum": 10 },
        "escalate_on_exhaustion": { "type": "boolean" }
      }
    }
  }
}
